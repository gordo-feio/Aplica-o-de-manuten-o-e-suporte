over automaticamente e reatribuir para outro t√©cnico
- Notificar atendente da mudan√ßa

---

#### 12.1.3 OS sem Nenhum T√©cnico Dispon√≠vel
**Problema:** Nenhum t√©cnico ativo no sistema

**Solu√ß√£o:**
- Mostrar alerta ao atendente ao criar OS
- Enviar email para admin
- OS fica em estado 'available' at√© algu√©m estar dispon√≠vel
- Dashboard admin mostra alerta de "OS sem cobertura"

---

#### 12.1.4 Todos os T√©cnicos Recusam OS
**Problema:** OS fica muito tempo sem ser aceita

**Solu√ß√£o:**
- Sistema de escalonamento autom√°tico
- Ap√≥s X horas ‚Üí notificar supervisor/admin
- Permitir atribui√ß√£o for√ßada por admin
- Aumentar prioridade automaticamente

---

#### 12.1.5 OS Ultrapassou Prazo
**Problema:** Deadline passou e OS ainda n√£o foi conclu√≠da

**Solu√ß√£o:**
- Badge vermelho "ATRASADA"
- Notifica√ß√£o para t√©cnico, atendente e admin
- Aparecer em relat√≥rio de OS atrasadas
- Bloquear fechamento sem justificativa

---

#### 12.1.6 T√©cnico Sai da OS no Meio
**Problema:** T√©cnico precisa sair por motivo urgente

**Solu√ß√£o:**
- Bot√£o "Solicitar Substitui√ß√£o"
- Notifica atendente
- Atendente pode:
  - Adicionar outro t√©cnico como support
  - Remover o t√©cnico e adicionar substituto
  - Cancelar OS e criar nova

---

#### 12.1.7 Ticket Alterado Ap√≥s OS Criada
**Problema:** Empresa altera descri√ß√£o do ticket

**Solu√ß√£o:**
- Notificar t√©cnicos da OS automaticamente
- Mostrar badge "Atualizado" na OS
- Log de altera√ß√µes vis√≠vel

---

#### 12.1.8 Empresa Cancela Ticket com OS Ativa
**Problema:** Empresa quer cancelar servi√ßo

**Solu√ß√£o:**
- Notificar t√©cnicos imediatamente
- Status OS ‚Üí 'cancelled'
- Pedir confirma√ß√£o se t√©cnico j√° est√° no local
- Registrar motivo do cancelamento

---

---

## üìà 13. M√âTRICAS E RELAT√ìRIOS

### 13.1 Relat√≥rios Necess√°rios

#### 13.1.1 Relat√≥rio de Performance por T√©cnico
**Dados:**
- Total de OS aceitas
- Total de OS conclu√≠das
- Tempo m√©dio de conclus√£o
- Taxa de conclus√£o no prazo
- Avalia√ß√£o m√©dia (se houver sistema de avalia√ß√£o)
- OS em andamento
- OS atrasadas

**Per√≠odo:** Hoje, Semana, M√™s, Ano, Customizado

**Formato:** Tabela + Gr√°ficos

---

#### 13.1.2 Relat√≥rio de OS por Status
**Dados:**
- Quantidade por status
- Gr√°fico de pizza
- Evolu√ß√£o temporal (linha do tempo)
- Tempo m√©dio em cada status

---

#### 13.1.3 Relat√≥rio de OS por Prioridade
**Dados:**
- Distribui√ß√£o de prioridades
- Tempo m√©dio de atendimento por prioridade
- Taxa de cumprimento de prazo por prioridade

---

#### 13.1.4 Relat√≥rio de Colabora√ß√£o
**Dados:**
- OS com m√∫ltiplos t√©cnicos
- Combina√ß√µes de t√©cnicos mais frequentes
- Efici√™ncia de equipes vs. t√©cnico √∫nico

---

#### 13.1.5 Relat√≥rio de Disponibilidade
**Dados:**
- Tempo m√©dio at√© primeira aceita√ß√£o
- OS que ficaram muito tempo dispon√≠veis
- Hor√°rios de pico (mais OS criadas)
- Cobertura de t√©cnicos por hor√°rio

---

---

## üîÑ 14. INTEGRA√á√ïES E AUTOMA√á√ïES

### 14.1 Sistema de Escalonamento Autom√°tico

**Regra 1:** OS dispon√≠vel por mais de 30 minutos ‚Üí Notificar supervisor

**Regra 2:** OS dispon√≠vel por mais de 1 hora (prioridade high) ‚Üí Escalonar para admin

**Regra 3:** OS atrasada ‚Üí Notifica√ß√£o di√°ria at√© resolu√ß√£o

**Regra 4:** T√©cnico sem aceitar OS h√° X dias ‚Üí Notificar para verificar disponibilidade

---

### 14.2 Sistema de Pontua√ß√£o (Gamifica√ß√£o - Futuro)

**Pontos por:**
- Aceitar OS rapidamente (+10)
- Concluir no prazo (+20)
- Concluir antes do prazo (+30)
- Avaliac√£o positiva da empresa (+15)
- Ajudar como support (+5)

**Ranking:**
- T√©cnico do m√™s
- Melhor tempo m√©dio
- Maior taxa de conclus√£o

---

### 14.3 Notifica√ß√µes por Email

**Criar template de email para:**
- Nova OS dispon√≠vel (t√©cnicos)
- OS aceita (atendente/empresa)
- OS conclu√≠da (empresa/atendente)
- OS atrasada (todos os envolvidos)
- Resumo di√°rio para t√©cnicos (suas OS ativas)

---

### 14.4 SMS/WhatsApp (Futuro)

**Integra√ß√£o com API para:**
- Notificar t√©cnico em campo
- Confirmar chegada no local
- Enviar localiza√ß√£o

---

---

## üß™ 15. TESTES NECESS√ÅRIOS

### 15.1 Testes Funcionais

#### 15.1.1 Cria√ß√£o de OS
- ‚úÖ Atendente pode criar OS de ticket assumido
- ‚úÖ Sistema impede criar OS de ticket n√£o assumido
- ‚úÖ Sistema impede criar OS duplicada
- ‚úÖ Prazo calculado corretamente por prioridade
- ‚úÖ Todos os t√©cnicos recebem notifica√ß√£o

---

#### 15.1.2 Aceita√ß√£o de OS
- ‚úÖ T√©cnico pode aceitar OS dispon√≠vel
- ‚úÖ Primeiro t√©cnico vira primary
- ‚úÖ Sistema impede dois t√©cnicos aceitarem simultaneamente
- ‚úÖ Status atualiza corretamente
- ‚úÖ Notifica√ß√µes enviadas

---

#### 15.1.3 M√∫ltiplos T√©cnicos
- ‚úÖ Primary pode adicionar support
- ‚úÖ Atendente pode adicionar support
- ‚úÖ Support n√£o pode adicionar outros
- ‚úÖ N√£o permite adicionar t√©cnico j√° na OS
- ‚úÖ Remo√ß√£o de t√©cnico funciona corretamente
- ‚úÖ Promo√ß√£o de support para primary quando necess√°rio

---

#### 15.1.4 Conclus√£o de OS
- ‚úÖ T√©cnico pode marcar sua parte como conclu√≠da
- ‚úÖ OS s√≥ completa quando todos finalizarem
- ‚úÖ Ticket atualiza status
- ‚úÖ Empresa √© notificada

---

### 15.2 Testes de Seguran√ßa

- ‚úÖ Empresa n√£o pode aceitar OS
- ‚úÖ T√©cnico n√£o pode aceitar OS de outro ap√≥s j√° ter aceitado
- ‚úÖ Valida√ß√£o de CSRF token em todas as a√ß√µes
- ‚úÖ SQL Injection prevenido (prepared statements)
- ‚úÖ XSS prevenido (sanitiza√ß√£o de inputs)

---

### 15.3 Testes de Performance

- ‚úÖ Listagem de OS dispon√≠veis r√°pida (< 1s)
- ‚úÖ Aceita√ß√£o de OS instant√¢nea (< 500ms)
- ‚úÖ Notifica√ß√µes n√£o travam o sistema
- ‚úÖ Dashboard carrega em menos de 2s

---

### 15.4 Testes de Usabilidade

- ‚úÖ Fluxo intuitivo para t√©cnico
- ‚úÖ F√°cil de usar em dispositivos m√≥veis
- ‚úÖ Mensagens de erro claras
- ‚úÖ Confirma√ß√µes antes de a√ß√µes cr√≠ticas

---

---

## üì± 16. MELHORIAS FUTURAS (ROADMAP)

### 16.1 Fase 1 (MVP - Funcionalidade B√°sica)
- ‚úÖ Cria√ß√£o de OS
- ‚úÖ Sistema de aceita√ß√£o (primeiro a clicar)
- ‚úÖ M√∫ltiplos t√©cnicos
- ‚úÖ Notifica√ß√µes b√°sicas
- ‚úÖ Conclus√£o de OS

---

### 16.2 Fase 2 (Melhorias)
- üìç GPS/Localiza√ß√£o em tempo real
- üì∏ Upload de fotos no campo (antes/depois)
- ‚è±Ô∏è Timer de trabalho (controle de horas)
- üìù Checklist de tarefas por OS
- ‚≠ê Sistema de avalia√ß√£o da empresa

---

### 16.3 Fase 3 (Avan√ßado)
- ü§ñ Sugest√£o autom√°tica de t√©cnico (IA/ML)
- üìä Dashboard anal√≠tico avan√ßado
- üó∫Ô∏è Roteamento otimizado de m√∫ltiplas OS
- üí¨ Chat em tempo real entre equipe
- üì± App mobile nativo

---

### 16.4 Fase 4 (Enterprise)
- üîó API p√∫blica para integra√ß√µes
- üìß Sistema de email pr√≥prio
- üì≤ Integra√ß√£o WhatsApp Business
- üéØ Sistema de metas e KPIs
- üí∞ Controle de custos por OS

---

---

## üóÇÔ∏è 17. ESTRUTURA DE ARQUIVOS - RESUMO

### 17.1 Novos Arquivos a Criar

```
classes/
‚îú‚îÄ‚îÄ WorkOrder.php                    # Classe principal de OS
‚îî‚îÄ‚îÄ WorkOrderNotification.php        # Notifica√ß√µes espec√≠ficas de OS

ajax/
‚îú‚îÄ‚îÄ create_work_order.php            # Criar OS
‚îú‚îÄ‚îÄ accept_work_order.php            # Aceitar OS
‚îú‚îÄ‚îÄ add_technician_to_os.php         # Adicionar t√©cnico
‚îú‚îÄ‚îÄ remove_technician_from_os.php    # Remover t√©cnico
‚îú‚îÄ‚îÄ complete_work_order.php          # Concluir OS
‚îú‚îÄ‚îÄ get_available_work_orders.php    # Listar dispon√≠veis
‚îú‚îÄ‚îÄ get_work_order_details.php       # Detalhes da OS
‚îî‚îÄ‚îÄ get_my_work_orders.php           # Minhas OS

views/work_orders/
‚îú‚îÄ‚îÄ available.php                    # Lista de OS dispon√≠veis
‚îú‚îÄ‚îÄ view.php                         # Detalhes da OS
‚îú‚îÄ‚îÄ my_orders.php                    # Minhas OS (t√©cnico)
‚îî‚îÄ‚îÄ manage.php                       # Gerenciar OS (atendente/admin)

sql/
‚îî‚îÄ‚îÄ work_orders_migration.sql        # Script de cria√ß√£o das tabelas
```

---

### 17.2 Arquivos a Modificar

```
config/
‚îî‚îÄ‚îÄ constants.php                    # Adicionar constantes de OS

includes/
‚îî‚îÄ‚îÄ functions.php                    # Adicionar fun√ß√µes helper de OS

views/dashboard/
‚îú‚îÄ‚îÄ dash_tecnico.php                 # Adicionar se√ß√£o de OS
‚îî‚îÄ‚îÄ dash_atendente.php               # Adicionar bot√£o criar OS

ajax/
‚îî‚îÄ‚îÄ dispatch_ticket.php              # Modificar para criar OS ao inv√©s de apenas despachar
```

---

---

## üéØ 18. CHECKLIST DE IMPLEMENTA√á√ÉO

### 18.1 Prepara√ß√£o do Banco de Dados
- [ ] Criar tabela `work_orders`
- [ ] Criar tabela `work_order_technicians`
- [ ] Criar tabela `work_order_logs`
- [ ] Adicionar campos em `tickets` (has_work_order, work_order_id)
- [ ] Adicionar novo status em tickets (work_order_created)
- [ ] Criar √≠ndices necess√°rios
- [ ] Testar integridade referencial

---

### 18.2 Classes PHP
- [ ] Criar `WorkOrder.php` com todos os m√©todos
- [ ] Criar `WorkOrderNotification.php`
- [ ] Testar cada m√©todo isoladamente
- [ ] Adicionar tratamento de erros
- [ ] Adicionar logs

---

### 18.3 Fun√ß√µes Helper
- [ ] Adicionar fun√ß√µes em `functions.php`
- [ ] Adicionar constantes em `constants.php`
- [ ] Testar cada fun√ß√£o

---

### 18.4 AJAX Endpoints
- [ ] Criar todos os arquivos AJAX
- [ ] Implementar valida√ß√µes de seguran√ßa
- [ ] Testar com Postman/Insomnia
- [ ] Adicionar tratamento de erros
- [ ] Documentar par√¢metros

---

### 18.5 Views (Front-end)
- [ ] Criar p√°gina de OS dispon√≠veis
- [ ] Criar p√°gina de detalhes da OS
- [ ] Criar p√°gina "Minhas OS"
- [ ] Criar p√°gina de gerenciamento (admin)
- [ ] Atualizar dashboards (t√©cnico/atendente)
- [ ] Adicionar modais necess√°rios
- [ ] Testar responsividade

---

### 18.6 Sistema de Notifica√ß√µes
- [ ] Implementar notifica√ß√µes para t√©cnicos
- [ ] Implementar notifica√ß√µes para atendentes
- [ ] Implementar notifica√ß√µes para empresas
- [ ] Testar notifica√ß√µes em tempo real
- [ ] Adicionar sons/badges

---

### 18.7 Testes
- [ ] Testes funcionais
- [ ] Testes de seguran√ßa
- [ ] Testes de performance
- [ ] Testes de usabilidade
- [ ] Testes em diferentes navegadores
- [ ] Testes mobile

---

### 18.8 Documenta√ß√£o
- [ ] Documentar API endpoints
- [ ] Criar manual do usu√°rio (t√©cnico)
- [ ] Criar manual do usu√°rio (atendente)
- [ ] Documentar fluxos do sistema
- [ ] Criar v√≠deos tutoriais (opcional)

---

### 18.9 Deploy
- [ ] Backup do banco de dados
- [ ] Executar migrations
- [ ] Deploy dos novos arquivos
- [ ] Testar em produ√ß√£o
- [ ] Monitorar erros
- [ ] Treinar usu√°rios

---

---

## üö® 19. PONTOS DE ATEN√á√ÉO CR√çTICOS

### 19.1 Concorr√™ncia
**PROBLEMA:** Dois t√©cnicos aceitando OS ao mesmo tempo

**SOLU√á√ÉO T√âCNICA:**
```sql
START TRANSACTION;
SELECT * FROM work_orders WHERE id = ? FOR UPDATE;
-- Verificar se ainda est√° available
-- Se sim, atualizar
COMMIT;
```

---

### 19.2 Notifica√ß√µes em Massa
**PROBLEMA:** Criar OS notifica 50 t√©cnicos simultaneamente

**SOLU√á√ÉO:**
- Usar fila de jobs (background processing)
- Ou notifica√ß√µes em lote
- Ou websockets para tempo real

---

### 19.3 Logs Excessivos
**PROBLEMA:** Muitos logs podem encher o banco

**SOLU√á√ÉO:**
- Pol√≠tica de reten√ß√£o (90 dias)
- Arquivar logs antigos
- Indexar corretamente

---

### 19.4 Timezone
**PROBLEMA:** T√©cnicos em fusos diferentes

**SOLU√á√ÉO:**
- Sempre salvar em UTC no banco
- Converter para timezone do usu√°rio no front-end
- Deixar claro qual timezone na interface

---

### 19.5 Anexos/Imagens
**PROBLEMA:** T√©cnicos tiram muitas fotos no campo

**SOLU√á√ÉO:**
- Comprimir imagens antes do upload
- Limitar tamanho/quantidade
- Armazenamento em cloud (S3, etc.)

---

---

## üìä 20. QUERIES SQL √öTEIS (EXEMPLOS)

### 20.1 Listar OS Dispon√≠veis
```sql
SELECT wo.*, t.title, t.description, c.name as company_name
FROM work_orders wo
INNER JOIN tickets t ON wo.ticket_id = t.id
INNER JOIN companies c ON t.company_id = c.id
WHERE wo.status = 'available'
ORDER BY 
    CASE wo.priority 
        WHEN 'high' THEN 1 
        WHEN 'medium' THEN 2 
        ELSE 3 
    END,
    wo.created_at ASC;
```

---

### 20.2 Verificar se T√©cnico Pode Aceitar OS
```sql
SELECT COUNT(*) 
FROM work_order_technicians 
WHERE work_order_id = ? 
AND technician_id = ?;
-- Se retornar 0 ‚Üí pode aceitar
```

---

### 20.3 Obter Equipe da OS
```sql
SELECT 
    wot.id,
    wot.role,
    wot.status,
    wot.accepted_at,
    u.name,
    u.email,
    u.phone
FROM work_order_technicians wot
INNER JOIN users u ON wot.technician_id = u.id
WHERE wot.work_order_id = ?
ORDER BY 
    CASE wot.role 
        WHEN 'primary' THEN 1 
        ELSE 2 
    END;
```

---

### 20.4 Estat√≠sticas do T√©cnico
```sql
SELECT 
    COUNT(*) as total,
    SUM(CASE WHEN wot.status = 'completed' THEN 1 ELSE 0 END) as completed,
    SUM(CASE WHEN wo.status = 'in_progress' THEN 1 ELSE 0 END) as in_progress,
    AVG(TIMESTAMPDIFF(HOUR, wot.accepted_at, wot.completed_at)) as avg_hours
FROM work_order_technicians wot
INNER JOIN work_orders wo ON wot.work_order_id = wo.id
WHERE wot.technician_id = ?
AND MONTH(wot.created_at) = MONTH(CURRENT_DATE())
AND YEAR(wot.created_at) = YEAR(CURRENT_DATE());
```

---

### 20.5 OS Atrasadas
```sql
SELECT wo.*, t.title, c.name as company_name
FROM work_orders wo
INNER JOIN tickets t ON wo.ticket_id = t.id
INNER JOIN companies c ON t.company_id = c.id
WHERE wo.status = 'in_progress'
AND wo.deadline < NOW()
ORDER BY wo.deadline ASC;
```

---

---

## üéì 21. BOAS PR√ÅTICAS

### 21.1 C√≥digo
- ‚úÖ Usar prepared statements (PDO)
- ‚úÖ Validar TODOS os inputs
- ‚úÖ Sanitizar outputs (XSS)
- ‚úÖ Usar transa√ß√µes para opera√ß√µes cr√≠ticas
- ‚úÖ Comentar c√≥digo complexo
- ‚úÖ Seguir PSR-12 (padr√£o PHP)
- ‚úÖ Evitar duplica√ß√£o de c√≥digo

---

### 21.2 Seguran√ßa
- ‚úÖ CSRF token em todos os forms
- ‚úÖ Verificar permiss√µes antes de cada a√ß√£o
- ‚úÖ Logs de a√ß√µes sens√≠veis
- ‚úÖ Rate limiting em APIs
- ‚úÖ Hashing de senhas (j√° implementado)
- ‚úÖ HTTPS obrigat√≥rio em produ√ß√£o

---

### 21.3 Performance
- ‚úÖ √çndices corretos no banco
- ‚úÖ Cache de queries frequentes
- ‚úÖ Pagina√ß√£o em listagens grandes
- ‚úÖ Lazy loading de imagens
- ‚úÖ Minificar CSS/JS em produ√ß√£o
- ‚úÖ CDN para assets est√°ticos

---

### 21.4 UX
- ‚úÖ Feedback visual em todas as a√ß√µes
- ‚úÖ Loading states
- ‚úÖ Mensagens de erro claras
- ‚úÖ Confirma√ß√£o antes de a√ß√µes destrutivas
- ‚úÖ Atalhos de teclado
- ‚úÖ Design responsivo

---

---

## üìû 22. SUPORTE E MANUTEN√á√ÉO

### 22.1 Monitoramento

**M√©tricas a monitorar:**
- Tempo m√©dio de resposta das APIs
- Quantidade de OS criadas/dia
- Tempo m√©dio at√© aceita√ß√£o
- Taxa de conclus√£o no prazo
- Erros 500 (logs)
- Notifica√ß√µes n√£o entregues

---

### 22.2 Backup

**Estrat√©gia:**
- Backup di√°rio autom√°tico
- Reten√ß√£o de 30 dias
- Backup antes de updates
- Testar restore mensalmente

---

### 22.3 Logs

**Estrutura de logs:**
```
logs/
‚îú‚îÄ‚îÄ work_orders_YYYY-MM-DD.log       # A√ß√µes em OS
‚îú‚îÄ‚îÄ notifications_YYYY-MM-DD.log     # Notifica√ß√µes
‚îú‚îÄ‚îÄ errors_YYYY-MM-DD.log            # Erros
‚îî‚îÄ‚îÄ performance_YYYY-MM-DD.log       # Performance
```

---

---

## ‚úÖ 23. CONCLUS√ÉO

Esta documenta√ß√£o fornece **TODO o planejamento necess√°rio** para implementar o sistema de Ordem de Servi√ßo com as seguintes funcionalidades principais:

### ‚ú® Funcionalidades Core
1. ‚úÖ Cria√ß√£o de OS a partir de ticket assumido
2. ‚úÖ Sistema de aceita√ß√£o (primeiro a clicar leva)
3. ‚úÖ M√∫ltiplos t√©cnicos na mesma OS
4. ‚úÖ Notifica√ß√µes em tempo real
5. ‚úÖ Controle de status e prazos
6. ‚úÖ Dashboard espec√≠fico para t√©cnicos
7. ‚úÖ Relat√≥rios e estat√≠sticas

### üìã Pr√≥ximos Passos
1. **Revisar** esta documenta√ß√£o com a equipe
2. **Priorizar** as funcionalidades (MVP primeiro)
3. **Criar** o script SQL das tabelas
4. **Implementar** as classes PHP
5. **Desenvolver** os endpoints AJAX
6. **Criar** as interfaces (views)
7. **Testar** exaustivamente
8. **Treinar** os usu√°rios
9. **Deploy** em produ√ß√£o
10. **Monitorar** e iterar

---

## üéØ RESUMO EXECUTIVO FINAL

| Item | Quantidade | Status |
|------|------------|--------|
| Tabelas Novas | 3 | üìù A criar |
| Altera√ß√µes em Tabelas | 1 | üìù A fazer |
| Classes PHP Novas | 2 | üìù A criar |
| Endpoints AJAX Novos | 8 | üìù A criar |
| Views Novas | 4 | üìù A criar |
| Fun√ß√µes Helper | 10 | üìù A adicionar |
| Constantes | 4 arrays | üìù A adicionar |
| Altera√ß√µes em Dashboards | 2 | üìù A modificar |

---

**üéâ Documenta√ß√£o completa e pronta para implementa√ß√£o!**